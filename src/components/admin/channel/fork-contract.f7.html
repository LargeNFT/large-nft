<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-fork-contract">

    <${Navbar} />

    <div class="page-content">

      <div class="row">
        <form class="col-100 large-66 center" @submit="${formSubmit}" id="import-fork-contract">

          <ul class="breadcrumb">
            <li><a href="/admin/channel/create-menu">Create Collection</a></li>
            <li>Fork Collection From Contract</li>
          </ul>

          <div class="block-title">Fork Collection From Contract</div>
          

          ${!forking ? $h`

            <div class="block-header">
              Enter the contract address of the collection to import. Must be standard ERC-721. Limit 10,000 tokens.
            </div>

            <div class="list media-list inset">
              <ul>
                <li>
                  <a href="#" class="item-link">
                    <div class="item-content">
                      <div class="item-inner">
                        <div class="item-title item-label">Contract Address</div>
                        <div class="item-input-wrap">
                          <input type="text" name="contractAddress" placeholder="Enter Contract Address" value="${contractAddress ? contractAddress : ''}" required />
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </div>

            <div class="row block">

              <div class="col-70"></div>

              <button type="submit" class="button button-fill col-30" tabindex="12" style="margin-bottom: 10px;">
                <i class="material-icons">fork_left</i> Fork
              </button>

            </div>

              
          ` : $h`
              <p></p>
          `}



          ${forking || forkOutput ? $h`

            <div class="card">
              <div class="card-content">
                  <div class="card-content card-content-padding">
  
                    ${forking ? $h`
                      <div class="fork-label">
                          Forking...
                      </div>
      
                      ${forkStatus? $h`
                          <div class="fork-status">
      
                              <div class="item">
                                  <label>Authors:</label> ${forkStatus.authors.saved} / ${forkStatus.authors.total} 
                              </div>
      
                              <div class="item"> 
                                  <label>Channels:</label> ${forkStatus.channels.saved} / ${forkStatus.channels.total}
                              </div>

                              <div class="item">
                                <label>Animations:</label> ${forkStatus.animations.saved} / ${forkStatus.animations.total} 
                              </div>
      
                              <div class="item">
                                  <label>Images:</label> ${forkStatus.images.saved} / ${forkStatus.images.total} 
                              </div>
      
                              <div class="item">
                                  <label>Items:</label> ${forkStatus.items.saved} / ${forkStatus.items.total} 
                              </div>
      
                              <div class="item">
                                <label>Themes:</label> ${forkStatus.themes.saved} / ${forkStatus.themes.total} 
                              </div>
      
                              <div class="item">
                                <label>Static Pages:</label> ${forkStatus.staticPages.saved} / ${forkStatus.staticPages.total} 
                              </div>
              
                          </div>
                      ` : $h`<span />`}
      
                    ` : $h`
                        <div class="fork-label" style="display:none;"></div>
                    `}
      
                    ${forkOutput ? $h`
                        <div class="fork-output" innerHTML="${forkOutput}" id="ipfs-fork-process" ></div>
                    ` : $h`
                        <div class="fork-output" style="display:none;"></div>
                    `}

                    ${channelId ? $h`
                      <a class="button button-fill" style="width: 200px; margin-top: 10px;" href="/admin/channel/show/${channelId}">View Collection</a>
                    ` : $h`<span />`}
  
                  </div>
              </div>
  
            </div>

          ` : $h`
            <span />
          `}


        </form>
      </div>



    </div>
  </div>

</template>


<style>

</style>


<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { IpfsService } from "../../../service/core/ipfs-service"
  import { ImportService } from "../../../service/core/import-service"

  import Navbar from "../../admin/navbar.f7.html"


  export default (props, { $, $on, $f7, $update }) => {

    let importService = ContainerService.getInstance(ImportService)
    let ipfsService = ContainerService.getInstance(IpfsService)
    let walletService = ContainerService.getWalletService()

    let contractAddress = props.contractAddress

    let owner 
    let channelId

    let forking = false
    let forkStatus 
    let forkOutput = ""



    $on('pageInit', async () => {

      owner = await walletService.getAddress()
      await $update()

    })



    const formSubmit = async (e) => {

      e.preventDefault()

      let formData = $f7.form.convertToData('#import-fork-contract')

      forking = true 
      $update()

      try {
        await importService.importExistingFromContract(formData.contractAddress)
      } catch(ex) {
        $f7.dialog.alert(ex.message, "There was an error")
      }

      forking = false
      $update()

    }


    $(document).on('fork-progress', async (e) => {

      if (e.detail.message) {
          forkOutput += `<p>${e.detail.message}</p>`
      }

      forkStatus = e.detail.forkStatus

      $update()

      let outputElement = document.getElementById('ipfs-fork-process')

      if (outputElement) {
          $(outputElement).scrollTop(outputElement.scrollHeight)
      }

    })





    return $render
  }

</script>