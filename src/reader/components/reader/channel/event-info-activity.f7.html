<template>

  <div class="card">
    <div class="card-header">Activity</div>
    <div class="card-content card-content-padding data-table">

      ${transactionsViewModel?.transactions?.length > 0 ? $h`

        <table class="event-table">
          <thead>
            <tr>
              <th class="label-cell">Transaction</th>
              <th>Events</th>
            </tr>
          </thead>
  
          <tbody>
    
            ${transactionsViewModel.transactions.map(transaction => $h`
              <transaction-row transaction="${transaction}" items="${transactionsViewModel.rowItemViewModels}"></transaction-row>
            `)}
          </tbody>
  
        </table>
  
        <div class="block margin-top margin-bottom">
          <div class="row">
            <div class="col-50">
                ${previousPageStartId ? $h`
                  <a href="${baseURI}activity/?offset=${previousPageStartId}" class="button button-outline color-gray">Previous</a>
                ` : $h` `}
            </div>
            <div class="col-50">
                ${nextPageStartId ? $h`
                  <a href="${baseURI}activity/?offset=${nextPageStartId}" class="button button-fill">Next</a>
                ` : $h` `}
            </div>
          </div>
  
        </div>
  
      ` : $h`
        ${loading ? $h`Loading...` : $h`No activity.`}
        
      `}

    </div>
  </div>

</template>


<style>
</style>

<script>

  export default (props, { $, $on, $f7, $update }) => {

    let transactionWebService = globalThis.container.get("TransactionWebService")
    let walletService = globalThis.container.get("WalletService")

    let baseURI = globalThis.container.get('baseURI')

    let display = parseInt(props.display)
    let startId = props.start

    let nextPageStartId
    let previousPageStartId

    let transactionsViewModel 

    let loading = true


    const link = (href) => {
        return `${baseURI + href}`
    } 


    const load = async () => {
      
      $f7.preloader.show()

      loading = true

      try  {

        transactionsViewModel = await transactionWebService.listFrom(display, startId)
        
        if (transactionsViewModel.transactions.length == display) {
          nextPageStartId = transactionsViewModel.transactions[display-1].previousId
        }

        //If we have a startId we are on page 2+ so we need to set the previous start offset
        if (startId) {
          let previousTransactionList = await transactionWebService.listTo(display+1, startId)
          previousPageStartId = previousTransactionList.transactions[display]._id
        }

      } catch(ex) { console.log(ex) }
      
      loading = false

      await $update()

      $f7.preloader.hide()


    }



    document.addEventListener('load-activities-events', async (e) => {
      startId = e.startId
      await load()
    })

    return $render
  }

</script>