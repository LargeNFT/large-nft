<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-create-channel">

    <${Navbar} />

    <div class="page-content">

      <div class="row">
        <div class="col-100 large-66 center">

          <div class="block-title">Create Collection</div>
          <form id="create-channel-form" @submit="${formSubmit}">

            <${ChannelForm} channel=${channelViewModel} 
                description_editor="create-channel-description-editor" 
                description_toolbar="create-channel-description-toolbar" 
                license_editor="create-channel-license-editor" 
                license_toolbar="create-channel-license-toolbar" 
                add_theme_popup=".add-theme-popup-channel-create"

            />

            <div class="row block">

              <div class="col-70"></div>

              <button type="submit" class="button button-fill col-30" tabindex="12" id="saveButton">
                Save
              </button>

            </div>

          </form>
        </div>
      </div>

      <div class="popup add-theme-popup-channel-create">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Add Theme</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
                <form id="add-theme-form-channel-create">
                    <${ThemeForm} 
                        cover_image_css_editor_id="add-theme-cover-image-editor-channel-create" 
                        animation_css_editor_id="add-theme-animation-editor-channel-create"
                    />

                    <div class="row block">

                        <div class="col-70"></div>
          
                        <button type="submit" class="button button-fill col-30" tabindex="12">
                           Add
                        </button>
          
                    </div>
                </form>
            </div>
          </div>
        </div>
      </div>

      <div class="popup edit-theme-popup-channel-create">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="title">Edit Theme</div>
                  <div class="right">
                    <!-- Link to close popup -->
                    <a class="link popup-close">Close</a>
                  </div>
                </div>
              </div>
              <div class="page-content">
                  <form id="edit-theme-form-channel-create">
                      
                      <${ThemeForm} 
                          cover_image_css_editor_id="edit-theme-cover-image-editor-channel-create" 
                          animation_css_editor_id="edit-theme-animation-editor-channel-create"
                          theme="${editingTheme}"
                      />

                      <div class="row block">

                          <div class="col-70"></div>
            
                          <button type="submit" class="button button-fill col-30" tabindex="12">
                            Save Changes
                          </button>
            
                      </div>
                  </form>
              </div>
            </div>
          </div>
      </div>


    </div>
  </div>

</template>

<style>

</style>


<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { WalletService } from "../../../service/core/wallet-service"
  import { QuillEditorService } from "../../../service/quill-editor-service"

  import { AuthorService } from "../../../service/author-service"
  import { ThemeService } from "../../../service/theme-service"

  import { ChannelService } from "../../../service/channel-service"
  import { Channel } from "../../../dto/channel"
  import { Author } from "../../../dto/author"

  import Navbar from "../../admin/navbar.f7.html"
  import ChannelForm from "../../admin/channel/form.f7.html"
  import ThemeForm from "../../admin/channel/theme-form.f7.html"
  import { Theme } from "../../../dto/theme"

  import hljs from "highlight.js"
  import Quill from 'quill'

  import { ethers } from "ethers"
  import Tagify from '@yaireo/tagify'

  import { v4 as uuidv4 } from 'uuid';


  export default (props, { $, $on, $f7, $update }) => {

    let channelService = ContainerService.getInstance(ChannelService)
    let authorService = ContainerService.getInstance(AuthorService)
    let quillEditorService = ContainerService.getInstance(QuillEditorService)
    let themeService = ContainerService.getInstance(ThemeService)

    let walletService = ContainerService.getWalletService()

    let licenseQuillEditor 
    let themeCoverCssEditor
    let themeAnimationCssEditor 

    let editingTheme

    hljs.configure({  
      languages: ['css']
    })


    let channelViewModel = {
      channel: {
        mintPrice: "0.00",
        royaltyPercent: "0",
        authorId: walletService.address
      },

      themes: []
    }
    



    const formSubmit = async (e) => {

      e.preventDefault()

      //Get data
      let channel = Object.assign(new Channel(), $f7.form.convertToData('#create-channel-form'))

      //Get content from quill
      channel.description = quillEditorService.activeEditor.getContents()
      channel.license = licenseQuillEditor.getContents()

      //Parse attributeOptions and category
      if (channel.attributeOptions) {
        channel.attributeOptions = JSON.parse(channel.attributeOptions)
      } else {
        channel.attributeOptions = []
      }
      
      if (channel.category) {
        channel.category = JSON.parse(channel.category).map( item => item.value)
      } else {
        channel.category = []
      }

      //If the author doesn't exist insert a 
      if (channel.authorId) {
        await authorService.insertIfNew(channel.authorId)
      }
      //Save
      try {

        await channelService.put(channel)

        //Save the themes
        for (let theme of channelViewModel.themes) {
          theme.channelId = channel._id
          await themeService.put(theme)
        }


        const toast = $f7.toast.show({
          text: 'Collection saved',
          closeTimeout: 2000,
          closeButton: true,
          position: 'bottom',
          horizontalPosition: 'right'
        })

        //Redirect
        $f7.views.main.router.navigate(`/admin/channel/show/${channel._id}`)

      } catch (ex) {
        $f7.dialog.alert(ex.errors, "There was an error")
      }

    }

    $on('pageInit', async (e, page) => {

      //Categories
      let categoryTagify = new Tagify(document.getElementById('category'))

      //Description
      quillEditorService.buildQuillPostEditor("#create-channel-description-editor", "#create-channel-description-toolbar")

      //License
      licenseQuillEditor = new Quill('#create-channel-license-editor', {
        bounds: ".page-content",
        modules: {
          toolbar: '#create-channel-license-toolbar',
        },
        theme: "snow"
      })




      $('.add-theme-popup-channel-create').on('popup:open', function (e) {

          themeCoverCssEditor = new Quill('#add-theme-cover-image-editor-channel-create', {
            bounds: ".page-content",
            theme: "snow",
            modules: {
              syntax: {
                highlight: text => hljs.highlightAuto(text).value,
              },          
              toolbar: false
            }
          })

          themeAnimationCssEditor = new Quill('#add-theme-animation-editor-channel-create', {
            bounds: ".page-content",
            theme: "snow",
            modules: {
              syntax: {
                highlight: text => hljs.highlightAuto(text).value,
              },          
              toolbar: false
            }
          })

      })

      $('#add-theme-form-channel-create').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#add-theme-form-channel-create'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        //Generate id
        theme._id = uuidv4()
        theme.dateCreated = new Date().toJSON()

        try {
          
          channelViewModel.themes.push(theme)

          //Clear form
          $f7.form.fillFromData('#add-theme-form-channel-create', {name: ""})
          themeCoverCssEditor.setText("")
          themeAnimationCssEditor.setText("")

          //Refresh theme list
          await $update()

          $f7.popup.close('.add-theme-popup-channel-create')


        } catch(ex) {
          $f7.dialog.alert(ex, "There was an error")
        }

      })

      $('#edit-theme-form-channel-create').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#edit-theme-form-channel-create'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        try {

          //Update list
          let existingTheme = channelViewModel.themes.filter( (theme) => theme._id == editingTheme._id)[0]
          channelViewModel.themes[channelViewModel.themes.indexOf(existingTheme)] = theme

          //Refresh theme list
          await $update()

          $f7.popup.close('.edit-theme-popup-channel-create')

        } catch(ex) {
          console.log(ex)
          $f7.dialog.alert(ex.errors, "There was an error")
        }

      })

      $(document).on('click', '.delete-theme', async function (e) {

        let id = $(e.target).data('id')

        $f7.dialog.confirm("Are you sure you want to delete this theme?", async () => {

          channelViewModel.themes = channelViewModel.themes.filter( (theme) => theme._id != id)

          //Refresh theme list
          await $update()

          const toast = $f7.toast.show({
            text: 'Theme deleted',
            closeTimeout: 2000,
            closeButton: true,
            position: 'bottom',
            horizontalPosition: 'right'
          })

        })

      })

      $(document).on('click', '.edit-theme', async function (e) {

        let id = $(e.target).data('id')

        editingTheme = channelViewModel.themes.filter( (theme) => theme._id == id)[0]

        //Init editors
        themeCoverCssEditor = new Quill('#edit-theme-cover-image-editor-channel-create', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

        themeAnimationCssEditor = new Quill('#edit-theme-animation-editor-channel-create', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

        //Populate form
        $f7.form.fillFromData('#edit-theme-form-channel-create', editingTheme)
        themeCoverCssEditor.setText(editingTheme.coverImageCSS ? editingTheme.coverImageCSS : "")
        themeAnimationCssEditor.setText(editingTheme.animationCSS ? editingTheme.animationCSS : "")

        await $update()

        $f7.popup.open('.edit-theme-popup-channel-create')

      })


    })

    return $render
  }

</script>