<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-edit-channel">

    <${Navbar} />

    <div class="page-content">

      <div class="row">
        <div class="col-100 large-66 center">

          <ul class="breadcrumb">
            <li><a href="/admin/channel/show/${channelViewModel.channel._id}">${channelViewModel.channel.title}</a></li>
            <li>Edit Collection</li>
          </ul>

          <form id="edit-channel-form" @submit="${formSubmit}">

            <${ChannelForm} 
              channel=${channelViewModel} 
              description_editor="edit-channel-description-editor"
              description_toolbar="edit-channel-description-toolbar" 
              license_editor="edit-channel-license-editor"
              license_toolbar="edit-channel-license-toolbar" 
              add_theme_popup=".add-theme-popup-channel-edit"
              add_static_page_popup=".add-static-page-popup-channel-edit" />

            <div class="row block">

              <div class="col-70"></div>

              <button type="submit" class="button button-fill col-30" tabindex="12" id="saveButton">
                Save
              </button>

            </div>

          </form>
        </div>
      </div>

      <div class="popup add-theme-popup-channel-edit">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Add Theme</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
              <form id="add-theme-form-channel-edit">
                <${ThemeForm} cover_image_css_editor_id="add-theme-cover-image-editor-channel-edit"
                  animation_css_editor_id="add-theme-animation-editor-channel-edit" />

                <div class="row block">

                  <div class="col-70"></div>

                  <button type="submit" class="button button-fill col-30" tabindex="12">
                    Add
                  </button>

                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="popup edit-theme-popup-channel-edit">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Edit Theme</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
              <form id="edit-theme-form-channel-edit">

                <${ThemeForm} cover_image_css_editor_id="edit-theme-cover-image-editor-channel-edit"
                  animation_css_editor_id="edit-theme-animation-editor-channel-edit" theme="${editingTheme}" />

                <div class="row block">

                  <div class="col-70"></div>

                  <button type="submit" class="button button-fill col-30" tabindex="12">
                    Save Changes
                  </button>

                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="popup add-static-page-popup-channel-edit popup-tablet-fullscreen">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Add Static Page</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
              <form id="add-static-page-form-channel-edit">
                <${StaticPageForm} 
                  static_page_content_editor_id="add-static-page-content-editor-channel-edit"
                  static_page_content_toolbar_id="add-static-page-content-toolbar-channel-edit"
                  image_button_input_id="add-static-page-image-button-input"
                  image_button_id="add-static-page-image-button" />

                <div class="row block">

                  <div class="col-70"></div>

                  <button type="submit" class="button button-fill col-30" tabindex="12">
                    Add
                  </button>

                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="popup edit-static-page-popup-channel-edit popup-tablet-fullscreen">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Edit Static Page</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
              <form id="edit-static-page-form-channel-edit">

                <${StaticPageForm} static_page_content_editor_id="edit-static-page-content-editor-channel-edit"
                  static_page_content_toolbar_id="edit-static-page-content-toolbar-channel-edit"
                  image_button_input_id="edit-static-page-image-button-input"
                  image_button_id="edit-static-page-image-button" static_page="${editingStaticPage}" />

                <div class="row block">

                  <div class="col-70"></div>

                  <button type="submit" class="button button-fill col-30" tabindex="12">
                    Save Changes
                  </button>

                </div>
              </form>
            </div>
          </div>
        </div>
      </div>






    </div>
  </div>

</template>

<style>
</style>


<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { ChannelService } from "../../../service/channel-service"
  import { ImageService } from "../../../service/image-service"
  import { ThemeService } from "../../../service/theme-service"
  import { StaticPageService } from "../../../service/static-page-service"
  import { UiService } from "../../../service/core/ui-service"

  import { QuillEditorService, CustomImageSpec } from "../../../service/quill-editor-service"

  import { Channel } from "../../../dto/channel"
  import { Theme } from "../../../dto/theme"
  import { StaticPage } from "../../../dto/static-page"

  import Navbar from "../../admin/navbar.f7.html"
  import ChannelForm from "../../admin/channel/form.f7.html"
  import hljs from "highlight.js"

  import Quill from 'quill'
  import ThemeForm from "../../admin/channel/theme-form.f7.html"
  import StaticPageForm from "../../admin/channel/static-page-form.f7.html"



  import { ethers } from "ethers"
  import Tagify from '@yaireo/tagify'
  import { v4 as uuidv4 } from 'uuid';


  export default (props, { $, $on, $f7, $update }) => {

    let channelService = ContainerService.getInstance(ChannelService)
    let imageService = ContainerService.getInstance(ImageService)
    let themeService = ContainerService.getInstance(ThemeService)
    let staticPageService = ContainerService.getInstance(StaticPageService)
    let uiService = ContainerService.getInstance(UiService)

    let quillEditorService = ContainerService.getInstance(QuillEditorService)

    let licenseQuillEditor
    let themeCoverCssEditor
    let themeAnimationCssEditor

    let staticPageContentEditor


    let editingTheme
    let editingStaticPage


    let channelViewModel = props.channelViewModel


    hljs.configure({
      languages: ['css']
    })

    const formSubmit = async (e) => {

      e.preventDefault()

      //Get data
      let channel = Object.assign(new Channel(), $f7.form.convertToData('#edit-channel-form'))

      //Get content from quill
      channel.description = quillEditorService.activeEditor.getContents()
      channel.license = licenseQuillEditor.getContents()



      //Parse attributeOptions and category
      if (channel.attributeOptions) {
        channel.attributeOptions = JSON.parse(channel.attributeOptions)
      } else {
        channel.attributeOptions = []

      }

      if (channel.category) {
        channel.category = JSON.parse(channel.category).map(item => item.value)
      } else {
        channel.category = []
      }

      //Save
      try {

        await channelService.put(channel)

        const toast = $f7.toast.show({
          text: 'Collection saved',
          closeTimeout: 2000,
          closeButton: true,
          position: 'bottom',
          horizontalPosition: 'right'
        })

        //Redirect
        $f7.views.main.router.navigate(`/admin/channel/show/${channel._id}`)

      } catch (ex) {
        $f7.dialog.alert(ex.errors, "There was an error")
      }

    }

    const updateThemeList = async () => {
      //Refresh theme list
      channelViewModel.themes = await themeService.listByChannel(channelViewModel.channel._id, 1000, 0)
    }

    const updateStaticPagesList = async () => {
      //Refresh static pages list
      channelViewModel.staticPages = await staticPageService.listByChannel(channelViewModel.channel._id, 1000, 0)
    }

    $on('pageInit', async (e, page) => {

      //Categories
      let categoryTagify = new Tagify(document.getElementById('category'))

      //Description
      quillEditorService.buildQuillPostEditor("#edit-channel-description-editor", "#edit-channel-description-toolbar")

      if (channelViewModel.channel.description) {
        quillEditorService.activeEditor.setContents(channelViewModel.channel.description)
      }

      //License
      licenseQuillEditor = new Quill('#edit-channel-license-editor', {
        bounds: ".page-content",
        modules: {
          toolbar: '#edit-channel-license-toolbar',
        },
        theme: "snow"
      })


      if (channelViewModel.channel.license) {
        licenseQuillEditor.setContents(channelViewModel.channel.license)
      }

      //Open attribute options too
      if (channelViewModel.channel?.attributeOptions?.length > 0) {

        for (let ao of channelViewModel.channel?.attributeOptions) {
          new Tagify(document.getElementById(`options-input-${ao.id}`))
        }

      }


      //Clear existing listeners
      $(document).off('click', '.delete-theme')
      $(document).off('click', '.edit-theme')
      
      $(document).off('click', '.delete-static-page')
      $(document).off('click', '.edit-static-page')


      /**
       *  THEMES
       */

      $('.add-theme-popup-channel-edit').on('popup:open', function (e) {

        themeCoverCssEditor = new Quill('#add-theme-cover-image-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },
            toolbar: false
          }
        })

        themeAnimationCssEditor = new Quill('#add-theme-animation-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },
            toolbar: false
          }
        })

      })

      $('#add-theme-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#add-theme-form-channel-edit'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        try {
          await themeService.put(theme)


          //Clear form
          $f7.form.fillFromData('#add-theme-form-channel-edit', { name: "" })
          themeCoverCssEditor.setText("")
          themeAnimationCssEditor.setText("")

          //Refresh theme list
          await updateThemeList()
          await $update()

          $f7.popup.close('.add-theme-popup-channel-edit')


        } catch (ex) {
          $f7.dialog.alert(ex.errors, "There was an error")
        }

      })

      $('#edit-theme-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#edit-theme-form-channel-edit'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        try {

          await themeService.put(theme)

          //Refresh theme list
          await updateThemeList()
          await $update()

          $f7.popup.close('.edit-theme-popup-channel-edit')

        } catch (ex) {
          console.log(ex)
          $f7.dialog.alert(ex.errors, "There was an error")
        }

      })

      $(document).on('click', '.delete-theme', async function (e) {

        let id = $(e.target).data('id')

        $f7.dialog.confirm("Are you sure you want to delete this theme?", async () => {

          let theme = await themeService.get(id)

          await themeService.delete(theme)

          //Refresh theme list
          await updateThemeList()
          await $update()

          const toast = $f7.toast.show({
            text: 'Theme deleted',
            closeTimeout: 2000,
            closeButton: true,
            position: 'bottom',
            horizontalPosition: 'right'
          })

        })

      })

      $(document).on('click', '.edit-theme', async function (e) {

        let id = $(e.target).data('id')

        editingTheme = await themeService.get(id)

        //Init editors
        themeCoverCssEditor = new Quill('#edit-theme-cover-image-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },
            toolbar: false
          }
        })

        themeAnimationCssEditor = new Quill('#edit-theme-animation-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },
            toolbar: false
          }
        })

        //Populate form
        $f7.form.fillFromData('#edit-theme-form-channel-edit', editingTheme)
        themeCoverCssEditor.setText(editingTheme.coverImageCSS ? editingTheme.coverImageCSS : "")
        themeAnimationCssEditor.setText(editingTheme.animationCSS ? editingTheme.animationCSS : "")

        await $update()

        $f7.popup.open('.edit-theme-popup-channel-edit')

      })




      /**
       *  STATIC PAGES
       */
      $('.add-static-page-popup-channel-edit').on('popup:open', function (e) {

        staticPageContentEditor = new Quill('#add-static-page-content-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            imageDropAndPaste: {
              // add an custom image handler
              handler: (imageDataUrl, type, imageData) => {
                const file = imageData.toFile()
                quillEditorService.insertImageInEditor(file, staticPageContentEditor)
              }
            },
            toolbar: '#add-static-page-content-toolbar-channel-edit',
            blotFormatter: {
              specs: [
                CustomImageSpec,
              ],
              align: {
                icons: {
                  left: "<i class='material-icons'>align_horizontal_left</i>",
                  center: "<i class='material-icons'>align_horizontal_center</i>",
                  right: "<i class='material-icons'>align_horizontal_right</i>"
                },

                toolbar: {
                  svgStyle: {
                    fontSize: '21px',
                  },
                }
              }
            },
          }
        })
      })

      $('#add-static-page-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let staticPage = Object.assign(new StaticPage(), $f7.form.convertToData('#add-static-page-form-channel-edit'))

        staticPage.content = staticPageContentEditor.getContents()
        staticPage.channelId = channelViewModel.channel._id

        //Generate id
        staticPage._id = uuidv4()
        staticPage.dateCreated = new Date().toJSON()

        try {

          await staticPageService.put(staticPage)

          //Clear form
          $f7.form.fillFromData('#add-static-page-form-channel-edit', { name: "", slug: "", locations: [] })
          staticPageContentEditor.setText("")

          //Refresh static page list
          await updateStaticPagesList()
          await $update()

          $f7.popup.close('.add-static-page-popup-channel-edit')


        } catch (ex) {
          console.log(ex)
          $f7.dialog.alert(ex, "There was an error")
        }

      })

      $('#edit-static-page-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let staticPage = Object.assign(new StaticPage(), $f7.form.convertToData('#edit-static-page-form-channel-edit'))

        staticPage.content = staticPageContentEditor.getContents()
        staticPage.channelId = channelViewModel.channel._id

        try {

          //Update list
          await staticPageService.put(staticPage)

          //Refresh static pages list
          await updateStaticPagesList()
          await $update()

          $f7.popup.close('.edit-static-page-popup-channel-edit')

        } catch (ex) {
          console.log(ex)
          $f7.dialog.alert(ex.errors, "There was an error")
        }

      })

      $(document).on('click', '.delete-static-page', async function (e) {

        let id = $(e.target).data('id')

        $f7.dialog.confirm("Are you sure you want to delete this static page?", async () => {

          let staticPage = await staticPageService.get(id)

          await staticPageService.delete(staticPage)

          //Refresh static pages list
          await updateStaticPagesList()
          await $update()

          const toast = $f7.toast.show({
            text: 'Static Page deleted',
            closeTimeout: 2000,
            closeButton: true,
            position: 'bottom',
            horizontalPosition: 'right'
          })

        })

      })

      $(document).on('click', '.edit-static-page', async function (e) {

        let id = $(e.target).data('id')

        editingStaticPage = channelViewModel.staticPages.filter((staticPage) => staticPage._id == id)[0]

        staticPageContentEditor = new Quill('#edit-static-page-content-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            imageDropAndPaste: {
              // add an custom image handler
              handler: (imageDataUrl, type, imageData) => {
                const file = imageData.toFile()
                quillEditorService.insertImageInEditor(file, staticPageContentEditor)
              }
            },
            toolbar: '#edit-static-page-content-toolbar-channel-edit',
            blotFormatter: {
              specs: [
                CustomImageSpec,
              ],
              align: {
                icons: {
                  left: "<i class='material-icons'>align_horizontal_left</i>",
                  center: "<i class='material-icons'>align_horizontal_center</i>",
                  right: "<i class='material-icons'>align_horizontal_right</i>"
                },

                toolbar: {
                  svgStyle: {
                    fontSize: '21px',
                  },
                }
              }
            },
          }
        })

        //Populate form
        $f7.form.fillFromData('#edit-static-page-form-channel-edit', editingStaticPage)
        staticPageContentEditor.setContents(editingStaticPage.content)

        await $update()

        $f7.popup.open('.edit-static-page-popup-channel-edit')

      })

      $('#add-static-page-image-button').on('click', function (e) {

        e.preventDefault()

        //Click actual input
        const imageButtonInput = $('#add-static-page-image-button-input')
        imageButtonInput.click()
      })

      $('#add-static-page-image-button-input').on('change', async function (e) {

        e.preventDefault()

        uiService.showSpinner("Processing image...")

        await quillEditorService.insertImageInEditor(this.files[0], staticPageContentEditor)

        uiService.hideSpinner()

      })


      $('#edit-static-page-image-button').on('click', function (e) {

        e.preventDefault()

        //Click actual input
        const imageButtonInput = $('#edit-static-page-image-button-input')
        imageButtonInput.click()
      })

      $('#edit-static-page-image-button-input').on('change', async function (e) {

        e.preventDefault()

        uiService.showSpinner("Processing image...")

        await quillEditorService.insertImageInEditor(this.files[0], staticPageContentEditor)

        uiService.hideSpinner()

      })






    })

    return $render
  }

</script>