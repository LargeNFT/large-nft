<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-fork-contract">

    <${Navbar} />

    <div class="page-content">

      <div class="row">
        <form class="col-100 large-66 center" @submit="${formSubmit}" id="import-from-reader">

          <div class="block block-strong inset col-100 no-margin-bottom">
            <div class="breadcrumbs ">
              <div class="breadcrumbs-item">
                <a href="/" class="link">
                  Home
                </a>
              </div>    
              <div class="breadcrumbs-separator"></div>
              <div class="breadcrumbs-item">
                <a class="link" href="/admin/channel/create-menu">Create & Import</a>
              </div> 
              <div class="breadcrumbs-separator"></div>
              <div class="breadcrumbs-item breadcrumbs-item-active">
                Fork Collection From Reader
              </div> 
            </div>
          </div>


          ${channel ? $h`
            
            <div class="block-title">Fork Collection From Reader</div>
            <div class="block-header">
              A <em>fork</em> is a copy of an NFT collection. Forking a project allows you to freely experiment with changes without affecting the original project. <a href="/admin/channel/view-forks">View existing forks.</a>
            </div>

            <div class="list media-list inset">
              <ul>
                <li>
                  <label class="item-radio item-radio-icon-start item-content">
                    <input type="radio" name="demo-media-radio" checked @change="${radioButtonChange}" value="existing" />
                    <i class="icon icon-radio" checked></i>
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">Create new experience around an existing collection.</div>
                      </div>
                      <div class="item-text">Collection items will not be editable and Reader will be configured to connect to existing smart contract to view ownership and create transactions.</div>
                    </div>
                  </label>
                </li>
                <li>
                  <label class="item-radio item-radio-icon-start item-content">
                    <input type="radio" name="demo-media-radio" @change="${radioButtonChange}" value="fork" />
                    <i class="icon icon-radio"></i>
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">Fork collection.</div>
                      </div>
                      <div class="item-text">Collection items can be added, deleted, or edited. Deploy and mint from a new smart contract.</div>
                    </div>
                  </label>
                </li>

              </ul>
            </div>


            <div class="block block-strong inset fork-block">

              <p>Forking <a href="${getBaseURI()}" class="external">${channel.title}</a></p>

              <div class="repo-name">

                <div class="left">
                  <strong>Author</strong>

                  <div class="list no-hairlines" style="margin: 0; padding-left: 0px;">
                    <ul>
                      <li class="item-content item-input" style="padding-left: 0px;">
                        <div class="item-inner">
                          <div class="item-input-wrap">
                            <select id="collection-author">
                              ${forkType == "existing" && author != undefined ? $h`
                                <option value="${author._id}">${truncateEthAddress(author._id)} (Original Author)</option>
                              ` : $h`

                                ${owner ? $h`
                                  <option value="${owner}">${truncateEthAddress(owner)}</option>
                                ` : $h`
                                  <option value="">None</option>
                                `}
                                
                              ` }
                            </select>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="right">
                  <strong>Collection Name</strong>

                  <div class="list no-hairlines" style="margin: 0; padding-left: 0px;">
                    <ul>
                      <li class="item-content item-input" style="padding-left: 0px;">
                        <div class="item-inner">

                            ${forkType == "existing" ? $h`
                              <div class="item-input-wrap ">
                                ${channel.title}
                              </div>
                            ` : $h`
                              <div class="item-input-wrap ">
                                <input type="text" value="${customName}" @change="${collectionTitleChange}" />
                                <span class="input-clear-button"></span>
                              </div>
                            ` }

                        </div>
                      </li>
                    </ul>
                  </div>

                </div>
              </div>
              

              <p>
                You are downloading all project data, including images and HTML, into a local web-based <a href="https://pouchdb.com" class="external">database</a> on your device.
              </p>

              ${!forking ? $h`
                <button type="submit" class="button button-fill col-30" tabindex="12" style="margin-bottom: 10px; width: 200px;">
                  <i class="material-icons">fork_left</i> Create Fork
                </button>
              ` : $h`
                  <span />
              `}

            </div>



          ` : $h`
            <div class="block-title">Loading...</div>
          `}
          


          ${forking || forkOutput ? $h`

            <div class="card">
              <div class="card-content">
                  <div class="card-content card-content-padding">
  
                    ${forking ? $h`
                      <div class="fork-label">
                          Forking...
                      </div>
      
                      ${forkStatus? $h`
                          <div class="fork-status">
      
                              <div class="item">
                                  <label>Authors:</label> ${forkStatus.authors.saved} / ${forkStatus.authors.total} 
                              </div>
      
                              <div class="item"> 
                                  <label>Channels:</label> ${forkStatus.channels.saved} / ${forkStatus.channels.total}
                              </div>

                              <div class="item">
                                <label>Animations:</label> ${forkStatus.animations.saved} / ${forkStatus.animations.total} 
                              </div>
      
                              <div class="item">
                                  <label>Images:</label> ${forkStatus.images.saved} / ${forkStatus.images.total} 
                              </div>
      
                              <div class="item">
                                  <label>Items:</label> ${forkStatus.items.saved} / ${forkStatus.items.total} 
                              </div>
      
                              <div class="item">
                                <label>Themes:</label> ${forkStatus.themes.saved} / ${forkStatus.themes.total} 
                              </div>
      
                              <div class="item">
                                <label>Static Pages:</label> ${forkStatus.staticPages.saved} / ${forkStatus.staticPages.total} 
                              </div>
              
                          </div>
                      ` : $h`<span />`}
      
                    ` : $h`
                        <div class="fork-label" style="display:none;"></div>
                    `}
      
                    ${forkOutput ? $h`
                        <div class="fork-output" innerHTML="${forkOutput}" id="ipfs-fork-process" ></div>
                    ` : $h`
                        <div class="fork-output" style="display:none;"></div>
                    `}

                    ${channelId ? $h`
                      <a class="button button-fill" style="width: 200px; margin-top: 10px;" href="/admin/channel/show/${channelId}">View Collection</a>
                    ` : $h`<span />`}
  
                  </div>
              </div>
  
            </div>

          ` : $h`
            <span />
          `}
          



        </form>
      </div>



    </div>
  </div>

</template>


<style>





</style>


<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { IpfsService } from "../../../service/core/ipfs-service"
  import { ImportService } from "../../../service/core/import-service"

  import Navbar from "../../admin/navbar.f7.html"

  import axios from "axios"

  export default (props, { $, $on, $f7, $update }) => {

    let importService = ContainerService.getInstance(ImportService)
    let ipfsService = ContainerService.getInstance(IpfsService)
    let walletService = ContainerService.getWalletService()

    let ipfsReady = ipfsService.ipfs != undefined
    let peerCount = ipfsService.peerCount

    let contractInfo 

    let forking = false
    let forkStatus 
    let forkOutput = ""

    let channel
    let author
    let owner
    
    let customName

    let channelId

    let forkType = "existing"

    const truncateEthAddress = (address) => {
      return walletService.truncateEthAddress(address)
    }

    const getBaseURI = () => {

      let baseURI = window.location.pathname

      //Get what's before admin
      return baseURI.substring(0, baseURI.indexOf('large/admin'))

    }


    const getChannel = async () => {
      let response = await axios.get(`${getBaseURI()}backup/export/backup/channels.json`)
      let channels = response.data
      return channels[0]
    }

    const getAuthor = async () => {
      let response = await axios.get(`${getBaseURI()}backup/export/backup/authors.json`)
      let authors = response.data
      return authors[0]
    }

    const getContractInfo = async () => {
      
      try {

        let response = await axios.get(`${getBaseURI()}backup/contract/contract.json`)
        let contract = response.data
        return contract

      } catch(ex) {
        console.log(ex)
      }

    }


    $on('pageInit', async () => {

      owner = await walletService.getAddress()

      channel = await getChannel()
      author = await getAuthor()

      contractInfo = await getContractInfo()

      customName = channel.title

      await $update()


    })

    const radioButtonChange = async (e) => {

      e.preventDefault()

      forkType = $(e.currentTarget).val()

      await $update()

    }

    const collectionTitleChange = async (e) => {
      e.preventDefault()
      customName = $(e.currentTarget).val()
      await $update()
    }

    const formSubmit = async (e) => {

      e.preventDefault()

      forking = true 
      $update()

      if (forkType == "existing") {
        channelId = await importService.importExistingFromReader(getBaseURI(), contractInfo.contractAddress, contractInfo.ipfsCid  )
      } else {
        channelId = await importService.importAsForkFromReader(getBaseURI(), customName)
      }
      

      forking = false
      $update()

    }


    $(document).on('fork-progress', async (e) => {

      if (e.detail.message) {
          forkOutput += `<p>${e.detail.message}</p>`
      }

      forkStatus = e.detail.forkStatus

      $update()

      let outputElement = document.getElementById('ipfs-fork-process')

      if (outputElement) {
          $(outputElement).scrollTop(outputElement.scrollHeight)
      }

    })


    return $render
  }

</script>