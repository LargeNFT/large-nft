<template>

  <div class="page" data-name="channel-list">

    <${Navbar} breadcrumbs=${breadcrumbs} />

    <div class="fab fab-extended fab-right-bottom">
      <a href="/admin/channel/create-menu">
        <i class="material-icons">create</i>
        <div class="fab-text">Create & Import</div>
      </a>
    </div>

    <div class="page-content infinite-scroll-content hide-toolbar-on-scroll" @infinite=${infiniteScroll} id="channel-index-infinite-scroll">

      <div class="fixed-width-content center">

        <div class="popup welcome-popup">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="title">Welcome and thank you for using Large!</div>
                  <div class="right">
                    <!-- Link to close popup -->
                    <a class="link popup-close">Close</a>
                  </div>
                </div>
              </div>
              <div class="page-content">

                <div class="block">
                  <strong>All data</strong> is in local storage (IndexedDB) in your browser and we can NEVER retreive it for you if it is lost. We do not have it and this is by design. 
              
                  <p>
                    Some browsers <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage_API/Storage_quotas_and_eviction_criteria">impose limitations</a> on how long data is stored before it is wiped due to inactivity. 
                    Installing Large NFT to your home screeen as a PWA makes it <a href="https://stackoverflow.com/questions/50795409/is-indexeddb-on-safari-guaranteed-to-be-persistent">less likely</a> for data to be lost but ultimately it's up to the browser. Publish critical data to GitHub/GitLab.
                  </p>
        
                  <p>Help make Large better by submitting bugs and feedback on <a href="https://github.com/LargeNFT/large-nft" class="external">GitHub</a>.</p>
          
                </div>

                
              </div>
            </div>
          </div>
        </div>
  

        <div class="card">
          <div class="card-content card-content-padding">
            Visit the <a href="/admin/settings">settings</a> to configure an AI provider, Git provider, and more.
          </div>
        </div>

  
        <div class="list list-strong list-dividers media-list virtual-list inset" id="channel-index-list">
        </div>
  
        <div class="preloader infinite-scroll-preloader"></div>

      </div>

    </div>

  </div>

</template>

<style>


</style>

<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { UiService } from "../../../service/core/ui-service"
  import { ImageService } from "../../../service/image-service"
  import { SettingsService } from "../../../service/core/settings-service"

  import { ChannelWebService } from "../../../service/web/channel-web-service"

  import Navbar from "../../admin/homenav.f7.html"

  export default (props, { $, $h, $on, $f7, $update }) => {

    let channelWebService = ContainerService.getInstance(ChannelWebService)
    let imageService = ContainerService.getInstance(ImageService)
    let uiService = ContainerService.getInstance(UiService)
    let settingsService = ContainerService.getInstance(SettingsService)

    let footerText = props.footerText


    const LIMIT = 20

    let channelsShown 
    let pageCounter
    let hasMoreChannels
    let loadingInProgress 

    let channels = []
    let virtualList
    
    let breadcrumbs = [{
        text: "Home"
    }]


    function unloadInfiniteScroll() {
      console.log("Unload infinite scroll")

      // Nothing more to load, detach infinite scroll events to prevent unnecessary loadings
      $f7.infiniteScroll.destroy('#channel-index-infinite-scroll')


      // Remove preloader
      $('.infinite-scroll-preloader').hide()

    }

    async function infiniteScroll() {

      // Exit, if loading in progress
      if (loadingInProgress || !hasMoreChannels) return

      uiService.showSpinner("Loading...")

      // Set loading flag
      loadingInProgress = true

      try {

        channels = await channelWebService.list(LIMIT, channelsShown)

        if (channels && channels.length == LIMIT) {
          channelsShown += channels.length
        } else {
          hasMoreChannels = false
        }

        if (pageCounter == 0) {
          //Remove the fake one
          virtualList.deleteAllItems()
        }

        virtualList.appendItems(channels)

      } catch (ex) {
        console.log(ex)
      }

      if (!hasMoreChannels) {
        unloadInfiniteScroll()
      }

      pageCounter++
      loadingInProgress = false

      uiService.hideSpinner()


    }


    $on('pageAfterOut', (e, page) => {
      unloadInfiniteScroll()
    })

    $on('pageInit', async (e, page) => {

      channelsShown = 0
      pageCounter = 0
      hasMoreChannels = true
      loadingInProgress = false


      //Get first page
      virtualList = $f7.virtualList.create({
        el: '#channel-index-list',

        renderItem(channelViewModel) {
          return getTemplate(channelViewModel)
        },
        items: [],
        setListHeight: false,
        emptyTemplate: `
              <li class="item-content">
                <div class="item-inner">
                    There are no collections yet. <br /><br />Click the 'Create & Import' button to create your first collection.
                </div>
              </li>
            `
      })

      //Get the page
      $('#channel-index-infinite-scroll').trigger('infinite')

      virtualList.on('itemsAfterInsert', (virtualList, fragment) => {

        //Find empty description divs and set their innerHTML
        $('.empty').each((element) => {

          const id = $(element).data('id')

          const c = channels.filter(channelViewModel => channelViewModel.channel._id == id)[0]

          if (c.channel.descriptionHTML) {
            element.innerHTML = c.channel.descriptionHTML
          }

          //Make links external
          let links = element.getElementsByTagName('a')

          for (let link of links) {
            link.classList.add('external')
          }

  
          $(element).removeClass('empty')
        })

        $('#channel-index-list ul').css("height", "")


      })

      let settings = await settingsService.get()

      if (!settings.welcomeHide) {

        const popup = $f7.popup.create({
          el: '.welcome-popup',
          on: {
            close:  async (popup) => {

              settings.welcomeHide = true
              await settingsService.put(settings)

            }
          }
        })

        popup.open()

      }

    })


    const getTemplate = (channelViewModel) => {
      return `
              <li>
                <a href="/admin/channel/show/${channelViewModel.channel._id}" class="item-link">
                  <div class="item-content">
                    <div class="item-media">
                      ${channelViewModel.coverImage ? `
                        <img src="${channelViewModel.coverImage.url}" class="avatar" alt="Channel cover image" />
                      ` : `
                        <i class="material-icons avatar">image</i>
                      `}
                    </div>
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">
                          ${channelViewModel.channel.title}                          
                        </div>
                        <div class="item-after"><span class="badge">${channelViewModel.itemCount}</span></div>
                      </div>

                      ${channelViewModel.authorDisplayName ? `
                        <div class="item-subtitle">
                          By ${channelViewModel?.authorDisplayName}
                        </div>
                      ` : ``}

                      <div class="description item-text empty" data-id="${channelViewModel.channel._id}"></div>
                    
                    </div>
                  </div>
                </a>
              </li>
          `
    }


    return $render
  }
</script>