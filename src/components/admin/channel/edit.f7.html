<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-edit-channel">

    <${Navbar} />

    <div class="page-content">

      <div class="row">
        <div class="col-100 large-66 center">

          <ul class="breadcrumb">
            <li><a href="/admin/channel/show/${channelViewModel.channel._id}">${channelViewModel.channel.title}</a></li>
            <li>Edit Collection</li>
          </ul>

          <form id="edit-channel-form" @submit="${formSubmit}">

            <${ChannelForm} channel=${channelViewModel} 
                description_editor="edit-channel-description-editor" 
                description_toolbar="edit-channel-description-toolbar" 
                license_editor="edit-channel-license-editor" 
                license_toolbar="edit-channel-license-toolbar" 
                add_theme_popup=".add-theme-popup-channel-edit"
              />

            <div class="row block">

              <div class="col-70"></div>

              <button type="submit" class="button button-fill col-30" tabindex="12" id="saveButton">
                Save
              </button>

            </div>

          </form>
        </div>
      </div>

      <div class="popup add-theme-popup-channel-edit">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">Add Theme</div>
                <div class="right">
                  <!-- Link to close popup -->
                  <a class="link popup-close">Close</a>
                </div>
              </div>
            </div>
            <div class="page-content">
                <form id="add-theme-form-channel-edit">
                    <${ThemeForm} 
                        cover_image_css_editor_id="add-theme-cover-image-editor-channel-edit" 
                        animation_css_editor_id="add-theme-animation-editor-channel-edit"
                    />

                    <div class="row block">

                        <div class="col-70"></div>
          
                        <button type="submit" class="button button-fill col-30" tabindex="12">
                           Add
                        </button>
          
                    </div>
                </form>
            </div>
          </div>
        </div>
      </div>

      <div class="popup edit-theme-popup-channel-edit">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="title">Edit Theme</div>
                  <div class="right">
                    <!-- Link to close popup -->
                    <a class="link popup-close">Close</a>
                  </div>
                </div>
              </div>
              <div class="page-content">
                  <form id="edit-theme-form-channel-edit">
                      
                      <${ThemeForm} 
                          cover_image_css_editor_id="edit-theme-cover-image-editor-channel-edit" 
                          animation_css_editor_id="edit-theme-animation-editor-channel-edit"
                          theme="${editingTheme}"
                      />

                      <div class="row block">

                          <div class="col-70"></div>
            
                          <button type="submit" class="button button-fill col-30" tabindex="12">
                            Save Changes
                          </button>
            
                      </div>
                  </form>
              </div>
            </div>
          </div>
      </div>


    </div>
  </div>

</template>

<style>
</style>


<script>

  import { ContainerService } from "../../../service/core/container-service"
  import { ChannelService } from "../../../service/channel-service"
  import { ImageService } from "../../../service/image-service"
  import { ThemeService } from "../../../service/theme-service"

  import { QuillEditorService } from "../../../service/quill-editor-service"

  import { Channel } from "../../../dto/channel"
  import { Theme } from "../../../dto/theme"

  import Navbar from "../../admin/navbar.f7.html"
  import ChannelForm from "../../admin/channel/form.f7.html"
  import hljs from "highlight.js"

  import Quill from 'quill'
  import ThemeForm from "../../admin/channel/theme-form.f7.html"

  

  import { ethers } from "ethers"
  import Tagify from '@yaireo/tagify'

  export default (props, { $, $on, $f7, $update }) => {

    let channelService = ContainerService.getInstance(ChannelService)
    let imageService = ContainerService.getInstance(ImageService)
    let themeService = ContainerService.getInstance(ThemeService)

    let quillEditorService = ContainerService.getInstance(QuillEditorService)

    let licenseQuillEditor
    let themeCoverCssEditor
    let themeAnimationCssEditor 

    let editingTheme

    let channelViewModel = props.channelViewModel


    hljs.configure({  
      languages: ['css']
    })

    const formSubmit = async (e) => {

      e.preventDefault()

      //Get data
      let channel = Object.assign(new Channel(), $f7.form.convertToData('#edit-channel-form'))

      //Get content from quill
      channel.description = quillEditorService.activeEditor.getContents()
      channel.license = licenseQuillEditor.getContents()



      //Parse attributeOptions and category
      if (channel.attributeOptions) {
        channel.attributeOptions = JSON.parse(channel.attributeOptions)
      } else {
        channel.attributeOptions = []

      }
      
      if (channel.category) {
        channel.category = JSON.parse(channel.category).map( item => item.value)
      } else {
        channel.category = []
      }

      //Save
      try {
        
        await channelService.put(channel)

        const toast = $f7.toast.show({
          text: 'Collection saved',
          closeTimeout: 2000,
          closeButton: true,
          position: 'bottom',
          horizontalPosition: 'right'
        })

        //Redirect
        $f7.views.main.router.navigate(`/admin/channel/show/${channel._id}`)

      } catch (ex) {
        $f7.dialog.alert(ex.errors, "There was an error")
      }

    }

    const updateThemeList = async () => {
      //Refresh theme list
      channelViewModel.themes = await themeService.listByChannel(channelViewModel.channel._id, 1000, 0)
    }

    $on('pageInit', async (e, page) => {

      //Categories
      let categoryTagify = new Tagify(document.getElementById('category'))

      //Description
      quillEditorService.buildQuillPostEditor("#edit-channel-description-editor", "#edit-channel-description-toolbar")

      if (channelViewModel.channel.description) {
        quillEditorService.activeEditor.setContents(channelViewModel.channel.description)
      }

      //License
      licenseQuillEditor = new Quill('#edit-channel-license-editor', {
        bounds: ".page-content",
        modules: {
          toolbar: '#edit-channel-license-toolbar',
        },
        theme: "snow"
      })


      if (channelViewModel.channel.license) {
        licenseQuillEditor.setContents(channelViewModel.channel.license)
      }

      //Open attribute options too
      if (channelViewModel.channel?.attributeOptions?.length > 0) {

        for (let ao of channelViewModel.channel?.attributeOptions) {
          new Tagify(document.getElementById(`options-input-${ao.id}`))
        }

      }



      $('.add-theme-popup-channel-edit').on('popup:open', function (e) {

        themeCoverCssEditor = new Quill('#add-theme-cover-image-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

        themeAnimationCssEditor = new Quill('#add-theme-animation-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

      })

      $('#add-theme-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#add-theme-form-channel-edit'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        try {
          await themeService.put(theme)


          //Clear form
          $f7.form.fillFromData('#add-theme-form-channel-edit', {name: ""})
          themeCoverCssEditor.setText("")
          themeAnimationCssEditor.setText("")

          //Refresh theme list
          await updateThemeList()
          await $update()

          $f7.popup.close('.add-theme-popup-channel-edit')


        } catch(ex) {
          $f7.dialog.alert(ex.errors, "There was an error")
        }
        
      })

      $('#edit-theme-form-channel-edit').on('submit', async function (e) {

        e.preventDefault()

        //Get data
        let theme = Object.assign(new Theme(), $f7.form.convertToData('#edit-theme-form-channel-edit'))

        theme.coverImageCSS = themeCoverCssEditor.getText() != "\n" ? themeCoverCssEditor.getText() : undefined
        theme.animationCSS = themeAnimationCssEditor.getText() != "\n" ? themeAnimationCssEditor.getText() : undefined
        theme.channelId = channelViewModel.channel._id

        try {

          await themeService.put(theme)

          //Refresh theme list
          await updateThemeList()
          await $update()

          $f7.popup.close('.edit-theme-popup-channel-edit')

        } catch(ex) {
          console.log(ex)
          $f7.dialog.alert(ex.errors, "There was an error")
        }

      })

      $(document).on('click', '.delete-theme', async function (e) {

        let id = $(e.target).data('id')

        $f7.dialog.confirm("Are you sure you want to delete this theme?", async () => {

          let theme = await themeService.get(id)

          await themeService.delete(theme)

          //Refresh theme list
          await updateThemeList()
          await $update()

          const toast = $f7.toast.show({
            text: 'Theme deleted',
            closeTimeout: 2000,
            closeButton: true,
            position: 'bottom',
            horizontalPosition: 'right'
          })

        })

      })

      $(document).on('click', '.edit-theme', async function (e) {

        let id = $(e.target).data('id')

        editingTheme = await themeService.get(id)

        //Init editors
        themeCoverCssEditor = new Quill('#edit-theme-cover-image-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

        themeAnimationCssEditor = new Quill('#edit-theme-animation-editor-channel-edit', {
          bounds: ".page-content",
          theme: "snow",
          modules: {
            syntax: {
              highlight: text => hljs.highlightAuto(text).value,
            },          
            toolbar: false
          }
        })

        //Populate form
        $f7.form.fillFromData('#edit-theme-form-channel-edit', editingTheme)
        themeCoverCssEditor.setText(editingTheme.coverImageCSS ? editingTheme.coverImageCSS : "")
        themeAnimationCssEditor.setText(editingTheme.animationCSS ? editingTheme.animationCSS : "")

        await $update()

        $f7.popup.open('.edit-theme-popup-channel-edit')

      })




    })

    return $render
  }

</script>