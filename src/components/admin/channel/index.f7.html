<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-posts">

    <${Navbar} />

    <div class="fab fab-extended fab-right-bottom">
      <a href="/admin/channel/create-menu" class="text-color-black">
        <i class="material-icons">create</i>
        <div class="fab-text">Create Collection</div>
      </a>
    </div>

    <div class="page-content infinite-scroll-content" @infinite=${infiniteScroll} id="channel-index-infinite-scroll">

      <div class="row">

        <div class="col-100 large-50 center">

          <div class="card">
            <div class="card-content card-content-padding">
              Note: Large is pre-release software and there are known and unknown bugs. It is 
              published with an MIT License and the <a href="https://gitlab.com/ptoner/large">code</a> can be copied or forked.
            </div>
          </div>

          <div class="list cards-list virtual-list" id="channel-index-list">
          </div>

          <div class="preloader infinite-scroll-preloader" id="channel-index-preloader"></div>

        </div>

        

      </div>


    </div>

  </div>

</template>

<style>

</style>

<script>

  import moment from "moment"

  import { ContainerService } from "../../../service/core/container-service"
  import { UiService } from "../../../service/core/ui-service"
  import { ImageService } from "../../../service/image-service"

  import { ChannelWebService } from "../../../service/web/channel-web-service"

  import Navbar from "../../admin/navbar.f7.html"



  export default (props, { $, $h, $on, $f7, $update }) => {

    let channelWebService = ContainerService.getInstance(ChannelWebService)
    let imageService = ContainerService.getInstance(ImageService)
    let uiService = ContainerService.getInstance(UiService)

    const LIMIT = 20

    let channelsShown 
    let pageCounter
    let hasMoreChannels
    let loadingInProgress 

    let channels = []
    let virtualList
    

    function unloadInfiniteScroll() {
      console.log("Unload infinite scroll")

      // Nothing more to load, detach infinite scroll events to prevent unnecessary loadings
      $f7.infiniteScroll.destroy('#channel-index-infinite-scroll')

      // $f7.virtualList.destroy('#channel-index-list')

      // Remove preloader
      $('#channel-index-preloader').hide()

    }

    async function infiniteScroll() {

      // Exit, if loading in progress
      if (loadingInProgress || !hasMoreChannels) return

      uiService.showSpinner("Loading...")

      // Set loading flag
      loadingInProgress = true

      try {
        channels = await channelWebService.list(LIMIT, channelsShown)

        if (channels && channels.length == LIMIT) {
          channelsShown += channels.length
        } else {
          hasMoreChannels = false
        }

        if (pageCounter == 0) {
          //Remove the fake one
          virtualList.deleteAllItems()
        }

        virtualList.appendItems(channels)

      } catch (ex) {
        console.log(ex)
      }

      if (!hasMoreChannels) {
        unloadInfiniteScroll()
      }

      pageCounter++
      loadingInProgress = false

      uiService.hideSpinner()


    }


    $on('pageAfterOut', (e, page) => {
      unloadInfiniteScroll()
    })

    $on('pageInit', (e, page) => {
      console.log('pageInit')

      channelsShown = 0
      pageCounter = 0
      hasMoreChannels = true
      loadingInProgress = false


      //Get first page
      virtualList = $f7.virtualList.create({
        el: '#channel-index-list',

        renderItem(channelViewModel) {
          if (!channelViewModel.channel) return `
          <li class="card skeleton-text skeleton-effect-wave">
            <div class="card-header">Loading Loading Loading</div>
            <div class="card-content card-content-padding">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi lobortis et massa ac
                interdum. Cras consequat felis at consequat hendrerit. Aliquam vestibulum vitae lorem ac iaculis.
                Praesent nec pharetra massa, at blandit lectus. Sed tincidunt, lectus eu convallis elementum, nibh nisi
                aliquet urna, nec imperdiet felis sapien at enim.</div>
          </li>
          `
          return getTemplate(channelViewModel);
        },
        items: [{
          title: 'Loading...'
        }],
        setListHeight: true,
        updatableScroll: true,
        height: function (channelViewModel) {

          if (!channelViewModel.channel) return 50

          //Called 'horrible solution but it works' by author.  https://jsfiddle.net/mnahara/1cn6xqLg/
          
          //Create a div, add the template to it, calculate height, destroy div
          const measuringDiv = document.createElement('div')
    
          measuringDiv.classList.add('list', 'cards-list')
          measuringDiv.innerHTML = `<ul id='find-me'>${getTemplate(channelViewModel)}</ul>`

          $('body').append(measuringDiv)

          let height = $('#find-me li').height()

          //Remove
          measuringDiv.parentNode.removeChild(measuringDiv)

          return height

        },
        emptyTemplate: `
              <li class="item-content">
                <div class="item-inner">
                    There are no collections yet. <br /><br />Click the 'Create Collection' button to create your first collection.
                </div>
              </li>
            `
      })

      //Get the page
      console.log("triggering")
      $('#channel-index-infinite-scroll').trigger('infinite')

      virtualList.on('itemsAfterInsert', (virtualList, fragment) => {

        //Find empty description divs and set their innerHTML
        $('.empty').each((element) => {

          const id = $(element).data('id')

          const c = channels.filter(channelViewModel => channelViewModel.channel._id == id)[0]

          element.innerHTML = c.channel.descriptionHTML

          //Make links external
          let links = element.getElementsByTagName('a')

          for (let link of links) {
            link.classList.add('external')
          }

  
          $(element).removeClass('empty')
        })

      })


    })


    const getTemplate = (channelViewModel) => {
      return `
              <li class="card channel-card">

                    <a href="/admin/channel/show/${channelViewModel.channel._id}">
                      <div class="card-header banner" ${channelViewModel.coverBanner ?
                          `style="background-image: url(${channelViewModel.coverBanner.url});" ` : ``}>

                            ${channelViewModel.coverImage ? `
                            <img src="${channelViewModel.coverImage.url}" class="avatar" />
                          ` : `
                            <i class="material-icons avatar">image</i>
                          `}

                      </div>
                    </a>

                    <div class="card-content">
                        <div class="card-content card-content-padding">
                          
                            <div class="title">
                              <a href="/admin/channel/show/${channelViewModel.channel._id}">
                                ${channelViewModel.channel.title}
                              </a>
                            </div>

                            ${channelViewModel.authorDisplayName ? `
                              <div class="name">
                                By <a href="/admin/author/show/${channelViewModel?.author._id}">${channelViewModel?.authorDisplayName}</a>
                              </div>
                            ` : ``}

                            <div class="description empty" id="channel-description-${channelViewModel.channel._id}" data-id="${channelViewModel.channel._id}"></div>
                           
                        </div>
                    </div>
              </li>
          `
    }


    return $render
  }
</script>