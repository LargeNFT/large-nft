<!--suppress JSAnnotator -->
<template>

    <div class="page" data-name="publish">

        <${Navbar} />

        <div class="page-content">
            <div class="row">

                <div class="col-100 large-50 center">

                    <div class="block block-strong inset col-100 no-margin-bottom">
                        <div class="breadcrumbs ">
                          <div class="breadcrumbs-item">
                            <a href="/" class="link">
                              Home
                            </a>
                          </div>    
                          <div class="breadcrumbs-separator"></div>
                          <div class="breadcrumbs-item">
                            <a href="/admin/channel/show/${channelViewModel.channel._id}" class="link">
                              ${channelViewModel.channel.title}
                            </a>
                          </div>     
                          <div class="breadcrumbs-separator"></div>
                          <div class="breadcrumbs-item">
                            <a class="link" href="/admin/publish/${channelViewModel.channel._id}">Publish</a>
                          </div> 
                          <div class="breadcrumbs-separator"></div>
                          <div class="breadcrumbs-item breadcrumbs-item-active">
                            Export To IPFS
                          </div> 
                        </div>
                    </div>


                    ${channelViewModel.itemCount > 0 ? $h`

                    <div class="block-title">Export</div>
                    <div class="card">

                        <div class="card-content">
                            <div class="card-content card-content-padding">
                                
                                <p>
                                    The JSON metadata for the collection and a snapshot of the source database
                                    will be exported to the IPFS node and a local git repository.
                                </p>

                                
                                ${settings?.personalAccessToken?.length > 0 ? $h`

                                    ${!ipfsReady ? $h`
                                        <div class="ipfs-label">IPFS Initializing...</div>
                                    ` : $h`
                                        <div class="ipfs-label">
                                            Status: <a href="/admin/connect">IPFS Ready</a>
                                        </div>
                                    `}


                                    ${publishing ? $h`
                                        <div class="publish-label">
                                            Exporting...
                                        </div>
    
                                        ${publishStatus? $h`
                                            <div class="publish-status">
    
                                                <h4>
                                                    NFT Collection Data
                                                </h4>
    
                                                <div class="item">
                                                    <label>Images:</label> ${publishStatus.images.saved} / ${publishStatus.images.total} 
                                                </div>
        
                                                <div class="item">
                                                    <label>Animations:</label> ${publishStatus.animations.saved} / ${publishStatus.animations.total} 
                                                </div>
    
                                                <div class="item">
                                                    <label>NFT Metadata:</label> ${publishStatus.nftMetadata.saved} / ${publishStatus.nftMetadata.total} 
                                                </div>
        
                                                <div class="item"> 
                                                    <label>Contract Metadata:</label> ${publishStatus.contractMetadata.saved} / ${publishStatus.contractMetadata.total}
                                                </div>
        
                                                <h4>
                                                    Database Backup
                                                </h4>
    
                                                <div class="item">
                                                    <label>Channels:</label> ${publishStatus.backups.channels.saved} /  ${publishStatus.backups.channels.total}
                                                </div>
        
                                                <div class="item">
                                                    <label>Authors:</label> ${publishStatus.backups.authors.saved} /  ${publishStatus.backups.authors.total}
                                                </div>
        
                                                <div class="item">
                                                    <label>Items:</label> ${publishStatus.backups.items.saved} / ${publishStatus.backups.items.total} 
                                                </div>
        
                                                <div class="item">
                                                    <label>Images:</label> ${publishStatus.backups.images.saved} / ${publishStatus.backups.images.total} 
                                                </div>
    
                                                <div class="item">
                                                    <label>Animations:</label> ${publishStatus.backups.animations.saved} / ${publishStatus.backups.animations.total} 
                                                </div>
    
                                                <div class="item">
                                                    <label>Themes:</label> ${publishStatus.backups.themes.saved} / ${publishStatus.backups.themes.total} 
                                                </div>
    
                                                <div class="item">
                                                    <label>Static Pages:</label> ${publishStatus.backups.staticPages.saved} / ${publishStatus.backups.staticPages.total} 
                                                </div>
    
                                            </div>
                                        ` : $h`<span />`}
    
                                    ` : $h`
                                        <div class="publish-label" style="display:none;"></div>
                                    `}
    
                                    ${publishOutput ? $h`
                                        <div class="publish-output" innerHTML="${publishOutput}" id="ipfs-publish-process" ></div>
                                    ` : $h`
                                        <div class="publish-output" style="display:none;"></div>
                                    `}
    
    
                                    ${showCurrentCid ? $h`
    
                                        <div class="pin-status">
                                            <p><strong>IPFS Hash:</strong> ${channelViewModel.channel.localCid}</p>
                                            <p><strong>Date Exported:</strong> ${channelViewModel.channel.localPubDate}</p>
                                        </div>
    
                                    ` : $h`<span />`}
    
    
                                    ${ipfsReady ? $h`
    
                                        ${showRefresh ? $h`
    
                                            <div class="chip chip-outline">
                                                <div class="chip-label">Success!</div>
                                            </div>
    
                                            <button class="button button-fill color-gray text-color-white" @click="${copyIPFSClick}" id="export-refresh-button">
                                                <i class="material-icons">refresh</i> Export Again
                                            </button>
    
    
                                        ` : $h`
    
                                            ${!publishing ? $h`
                                                <button class="button button-fill button-small deploy-button" @click="${copyIPFSClick}">Export</button>
                                            ` : $h`<span />`}  
    
                                        `}
                                        
                                    ` : $h`
                                        <p></p>
                                    `}


                                ` : $h`
                                    <p>Configure <a href="/admin/settings">Gitlab</a> to begin export.</p>
                                `}


                            </div>
                        </div>

                    </div>

                    ` : $h`
                    <div class="card">
                        <div class="card-content card-content-padding">
                            <p>Add NFTs to the collection before publishing.</p>
                        </div>
                    </div>

                    `}

                </div>

            </div>
        </div>

    </div>

</template>

<style>
    .deploy-button {
        margin-top: 10px;
        width: 200px;
    }

    .publish-label,
    .ipfs-label,
    .forking-label {
        margin-top: 10px;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 18px;
    }

    .publish-output {
        border: 1px solid #cccccc;
        font-size: 13px;
        width: 100%;
        max-width: 100%;
        padding: 5px;
        height: 100px;
        overflow-y: scroll;
    }

    .publish-status {
        font-size: 14px;
        padding: 10px;
        border: 1px solid #f1f1f1;
    }

    .publish-status .item label {
        font-weight: bold;
        display: inline-block;
        width: 180px;
    }

    #export-refresh-button {
        width: 45px;
        height: 30px;
        display: inline-block;
        margin-left: 5px;
        padding-top: 2.5px;
    }

    #export-next-button {
        width: 200px;
        float: right;
    }

</style>

<script>

    import moment from "moment"

    import { ContainerService } from "../../../service/core/container-service"
    import { ChannelService } from "../../../service/channel-service"
    import { PublishService } from "../../../service/core/publish-service"

    import { PinningService } from "../../../service/core/pinning-service"
    import { GitlabService } from "../../../service/core/gitlab-service"

    import { QueueService } from "../../../service/core/queue-service"

    import { IpfsService } from "../../../service/core/ipfs-service"


    import Navbar from "../../admin/navbar.f7.html"


    export default (props, { $, $h, $on, $f7, $update }) => {

        let channelService = ContainerService.getInstance(ChannelService)
        let pinningService = ContainerService.getInstance(PinningService)
        let ipfsService = ContainerService.getInstance(IpfsService)
        let queueService = ContainerService.getInstance(QueueService)
        let gitlabService = ContainerService.getInstance(GitlabService)
        let publishService = ContainerService.getInstance(PublishService)

        let channelViewModel = props.channelViewModel
        let settings = props.settings

        let peerCount = ipfsService.peerCount

        let publishing = false
        let publishStatus 
        let publishOutput = ""

        let ipfsReady = ipfsService.ipfs != undefined

        let showCurrentCid = channelViewModel.channel.localCid?.length > 0

        let pageUnloaded = false

        let showRefresh = false
        

        $on('pageInit', async () => {

            pageUnloaded = false

            //Initialize IPFS
            await ipfsService.init()
            ipfsReady = ipfsService.ipfs != undefined

            await $update()

        })

        $on('pageAfterOut', (e, page) => {
            console.log("Unloading page")
            pageUnloaded = true
        })

        const copyIPFSClick = async (e) => {

            showCurrentCid = false
            publishing = true

            await $update()

            let elem = document.getElementsByClassName('publish-label')[0]

            $f7.preloader.showIn(elem)

            //Now publish
            try {
                
                await publishService.publish(channelViewModel.channel)

                //Get updated channel
                channelViewModel.channel = await channelService.get(channelViewModel.channel._id)

            } catch(ex) {
                console.log(ex)
                $f7.dialog.alert(ex.errors, "There was an error")
            }
            

            $f7.preloader.hideIn(elem)

            publishing = false
            showCurrentCid = true
            showRefresh = true

            await $update()

        }

        $(document).on('publish-progress', async (e) => {

            if (e.detail.message) {
                publishOutput = `<p>${e.detail.message}</p>`
            }
            
            publishStatus = e.detail.publishStatus

            $update()

            let outputElement = document.getElementById('ipfs-publish-process')

            if (outputElement) {
                $(outputElement).scrollTop(outputElement.scrollHeight)
            }
            
        })


        $(document).on('update-peers', async (e) => {
            peerCount = e.detail.count
            $update()
        })

        return $render
    }
</script>