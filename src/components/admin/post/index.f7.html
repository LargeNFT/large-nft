<!--suppress JSAnnotator -->
<template>

    <div class="page" data-name="admin-posts">
  
      <div class="navbar">
        <div class="navbar-bg"></div>
        <div class="navbar-inner">
          <div class="title">Blog Posts</div>
          <div class="right">
            <${HeaderRight} />
          </div>
        </div>
      </div>
  
      <div class="toolbar tabbar toolbar-top">
        <div class="toolbar-inner">
          <a class="tab-link tab-link-active">Published</a>
          <a class="tab-link" href="#"> Drafts</a>
        </div>
      </div>
  
  
  
      <div class="fab fab-extended fab-right-bottom">
        <a href="/admin/post/create" class="text-color-black">
          <i class="material-icons">create</i>
          <div class="fab-text">Create Post</div>
        </a>
      </div>
  
  
  
  
      <div class="page-content infinite-scroll-content">
        <div class="list virtual-list no-margin" id="blog-post-list">
        </div>
      </div>
  
    </div>
  
  </template>
  
  
  
  <script>
  
    import { ContainerService } from "../../../service/container-service"
    // import { QuillService } from "../../../service/quill-service"
    import { BlogPostService } from "large-core"

    import HeaderRight from "../../admin/header-right.f7.html"


    export default (props, { $, $on, $f7, $update }) => {
  
        let blogPostService = ContainerService.getInstance(BlogPostService)

        let postsShown = 0
        let lastPost = undefined
        let hasMorePosts = true
        let loadingInProgress = false

        let posts = []
        let virtualList

        function unloadInfiniteScroll() {
            console.log("Unload infinite scroll")

            // Nothing more to load, detach infinite scroll events to prevent unnecessary loadings
            $f7.infiniteScroll.destroy('.infinite-scroll-content')

            // Remove preloader
            $('.infinite-scroll-preloader').hide()
        }

        async function infiniteScroll() {

            // Exit, if loading in progress
            if (loadingInProgress || !hasMorePosts) return

            // Set loading flag
            loadingInProgress = true

            try {
                posts = await blogPostService.getPosts(10, postsShown, lastPost )

                if (posts && posts.length > 0) {
                    postsShown += posts.length
                    lastPost = posts[posts.length -1]._id
                } else {
                    hasMorePosts = false
                }

                virtualList.appendItems(posts)

            } catch(ex) {
                console.log(ex)
            }


            if (!hasMorePosts) {
                unloadInfiniteScroll()
            }

            loadingInProgress = false
        }


        // Attach 'infinite' event handler
        $('.infinite-scroll-content').on('infinite', async function () {
            await infiniteScroll()
        })


        $on('pageAfterOut', (e, page) => {
            unloadInfiniteScroll()
        })

        $on('pageInit', (e, page) => {

          //Get first page
          posts = blogPostService.getPosts(10, 0).then( posts => {

                virtualList = $f7.virtualList.create({
                el: '#blog-post-list',

                renderItem(item) {
                    return `
                        <li>
                            <a href="/admin/post/show/${item._id}" class="item-link item-content">

                            <div class="item-media">
                                ${coverPhotoSrc ? $h` 
                                    <img class="cover-photo-thumb" src="${item.coverPhotoSrc}">
                                ` : $h`
                                    <i class="f7-icons cover-photo-thumb">document</i>
                                `}
                            </div>    
                            
                            <div class="item-inner">
                                    <div class="item-title">
                                        ${item.title}
                                        <div class="item-footer">${item.dateCreatedDisplay}}</div>
                                    </div>
                            </div>
                            </a>
                        </li>
                    `;
                },

                items: posts,
                setListHeight: true,
                updatableScroll: true,
                height: function() {

                    if (window['Global'].app.theme === 'md') {
                    return 56
                    } else if (window['Global'].app.theme === 'ios') {
                    return 44
                    } else if (window['Global'].app.theme === 'aurora') {
                    return 42
                    }
                },
                emptyTemplate: `
                    <li class="item-content">
                            <div class="item-inner">
                                There are no blog posts yet. <br /><br />Click the 'Create Post' button to create your first blog post.
                            </div>
                    </li>
                `
            })
          })




            //Get the page
          $('.infinite-scroll-content').trigger('infinite')


        })
  

      return $render
    }
  </script>