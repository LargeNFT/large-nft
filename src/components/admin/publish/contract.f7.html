<!--suppress JSAnnotator -->
<template>

    <div class="page" data-name="publish">
  
      <${Navbar} />
  
      <div class="page-content">
        <div class="row">
  
          <div class="col-100 large-50 center">

            <ul class="breadcrumb">
                <li><a href="/admin/channel/show/${channelViewModel.channel._id}">${channelViewModel.channel.title}</a></li>
                <li>Publish</li>
            </ul>

            ${channelViewModel.itemCount > 0 ? $h`
              
              <div class="block-title">Publish</div>
              <div class="block list">
                <ul>
                  <li>
                    <a href="/admin/publish/export/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Export to local IPFS
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/pinata/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Publish to Pinata
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/create-reader/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Create New Reader
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/create-reader/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Publish Collection to Reader
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>

              <div class="block-title">Verify Mint Info</div>
              <div class="card">
                <div class="card-content">
                  <div class="card-content card-content-padding">

                    <p>
                      <strong>Mint Price:</strong> ${channelViewModel.channel.mintPrice} ETH each
                    </p>

                    <p>
                      <strong>Royalty:</strong> ${channelViewModel.channel.royaltyPercent}% 
                    </p>

                  </div>
                </div>
              </div>
              
              <div class="block-title">Deploy Contract</div>
              <div class="card">
                <div class="card-content">
                  <div class="card-content card-content-padding">
                    ${showDeploy ? $h`

                      <p><strong>Contract Address:</strong> ${channelViewModel.channel.contractAddress}</p>

                      ${deploying ? $h`
                        <p>Deploying...</p>
                      ` : $h`
                        ${!channelViewModel.channel.contractAddress ? $h`
                          <button class="button button-fill button-small deploy-button" @click="${deployContractClick}">Deploy Contract</button>
                        ` : $h`
                          <p>Success!</p>
                        `}                        
                      `}

                      
                    ` : $h`
                      <p>Collection must be deployed to Pinata</p>
                    `}
                  </div>
                </div>
              </div>

            ` : $h`
              <div class="card">
                <div class="card-content card-content-padding">
                  <p>Add NFTs to the collection before publishing.</p>
                </div>
              </div>
              
            `}

          </div>
  
        </div>
      </div>
  
    </div>
  
  </template>
  
  <style>

  </style>
  
  <script>
  
    import moment from "moment"
  
    import { ContainerService } from "../../../service/core/container-service"
    import { ChannelService } from "../../../service/channel-service"
    import { PublishService } from "../../../service/core/publish-service"

    import { PinningService } from "../../../service/core/pinning-service"
    import { GitlabService } from "../../../service/core/gitlab-service"

    import { QueueService } from   "../../../service/core/queue-service"

    import { IpfsService } from "../../../service/core/ipfs-service"


    import Navbar from "../../admin/navbar.f7.html"
    
  
    export default (props, { $, $h, $on, $f7, $update }) => {
  
        let channelService = ContainerService.getInstance(ChannelService)
        let pinningService = ContainerService.getInstance(PinningService)
        let ipfsService = ContainerService.getInstance(IpfsService)
        let queueService = ContainerService.getInstance(QueueService)
        let gitlabService = ContainerService.getInstance(GitlabService)
        let publishService = ContainerService.getInstance(PublishService)


        let channelViewModel = props.channelViewModel

        let deploying = false 

        let showDeploy = channelViewModel.channel.publishedCid && channelViewModel.channel.pinJobStatus == "complete"


        const deployContractClick = async (e) => {

          deploying = true
          await $update()
          
          let promiseView = {
            title: `Deploying contract ${name}. Waiting for transaction to be mined.`,
            promise: publishService.deployContract(channelViewModel.channel)
          }

          //Wait for it to be mined
          await queueService.queuePromiseView(promiseView)
          
          deploying = false
          await $update()
        }

        return $render
    }
  </script>