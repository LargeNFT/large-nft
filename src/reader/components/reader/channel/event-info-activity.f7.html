<template>

  <div class="card">
    <div class="card-header">Activity</div>
    <div class="card-content card-content-padding data-table">

      ${eventList?.length > 0 ? $h`

        <table class="event-table">
          <thead>
            <tr>
              <th class="label-cell">Event</th>
              <th class="image-col">Token</th>
              <th class="token-col">Title</th>
              <th>Date</th>
              <th>From</th>
              <th>To</th>
              <th>Etherscan</th>
  
            </tr>
          </thead>
  
          <tbody>
  
          ${eventList.map(evm => $h`
            <tr class="${getRowClass(evm.ercEvent)}">
              <td class="label-cell">
                ${evm.ercEvent.event} ${evm.ercEvent.isMint ? $h`<span class="badge">Mint</span>` : $h`<span />`}              
              </td>
  
              <td class="image-col">
  
                ${evm.rowItemViewModel ? $h`
                  <a href="${baseURI}t/${evm.ercEvent.tokenId}" class="link">
                    <img src="${imageLink(evm.rowItemViewModel)}" class="latest-img"/> 
                  </a>
                    ` : $h`<span />`}
  
              </td>
  
              <td class="token-col">
                ${evm.rowItemViewModel?.title}
              </td>
  
              <td>
                <strong>${moment(evm.ercEvent.timestamp * 1000).fromNow()}</strong>
              </td>
  
              <td>
                ${evm.ercEvent.fromAddress ? $h`
                  <a href="${baseURI}u/?address=${evm.ercEvent.fromAddress}">${walletService.truncateEthAddress(evm.ercEvent.fromAddress)}</a>
                ` : $h`<span />`}
              </td>
              <td>
                ${evm.ercEvent.toAddress ? $h`
                  <a href="${baseURI}u/?address=${evm.ercEvent.toAddress}">${walletService.truncateEthAddress(evm.ercEvent.toAddress)}</a>
                ` : $h`<span />`}
              </td>
              <td>
                <a href="https://etherscan.io/tx/${evm.ercEvent.transactionHash}" class="link external">View</a>
              </td>
  
            </tr>
          
          `)}
          </tbody>
  
        </table>
  
        <div class="block margin-top">
          <div class="row">
            <div class="col-50">
                ${previousPageStartId ? $h`
                  <a href="${baseURI}activity/?offset=${previousPageStartId}" class="button button-outline color-gray">Previous</a>
                ` : $h` `}
            </div>
            <div class="col-50">
                ${nextPageStartId ? $h`
                  <a href="${baseURI}activity/?offset=${nextPageStartId}" class="button button-fill">Next</a>
                ` : $h` `}
            </div>
          </div>
  
        </div>
  
      ` : $h`
        ${loading ? $h`Loading...` : $h`No activity.`}
        
      `}

    </div>
  </div>

</template>


<style>
</style>

<script>

  export default (props, { $, $on, $f7, $update }) => {

    let transactionWebService = globalThis.container.get("TransactionWebService")
    let walletService = globalThis.container.get("WalletService")

    let baseURI = globalThis.container.get('baseURI')
    let moment = globalThis.moment 

    let display = parseInt(props.display)
    let startId = props.start

    let nextPageStartId
    let previousPageStartId

    let eventList = []

    let loading = true

    const imageLink = (rowItemViewModel) => {
      let imgExt = rowItemViewModel.coverImageGenerated ? 'svg' : 'jpg'
      return link('backup/export/images/' + rowItemViewModel.coverImageId + "." + imgExt)
    }


    const link = (href) => {
        return `${baseURI + href}`
    } 

    const getRowClass = (event) => {
      if (event.isTransfer) return "event-transfer"
      if (event.event == "MintEvent") return "event-transfer"
      return "uncategorized-event"
    }

    const load = async () => {
      
      $f7.preloader.show()

      loading = true

      try  {

        // eventList = await eventWebService.listFrom(display, startId)
        
        // if (eventList.length == display) {
        //   nextPageStartId = eventList[display-1].ercEvent.previousId
        // }

        // //If we have a startId we are on page 2+ so we need to set the previous start offset
        // if (startId) {
        //   let previousEventList = await eventWebService.listTo(display+1, startId)
        //   previousPageStartId = previousEventList[display].ercEvent._id
        // }


      } catch(ex) { console.log(ex) }
      
      loading = false

      await $update()

      $f7.preloader.hide()


    }



    document.addEventListener('load-activities-events', async (e) => {
      startId = e.startId
      await load()
    })

    return $render
  }

</script>