<!--suppress JSAnnotator -->
<template>

    <div class="page" data-name="publish">
  
      <${Navbar} />
  
      <div class="page-content">
        <div class="row">
  
          <div class="col-100 large-50 center">

            <ul class="breadcrumb">
                <li><a href="/admin/channel/show/${channelViewModel.channel._id}">${channelViewModel.channel.title}</a></li>
                <li>Publish</li>
            </ul>

            ${channelViewModel.itemCount > 0 ? $h`
              
              <div class="block-title">Publish</div>
              <div class="block list">
                <ul>
                  <li>
                    <a href="/admin/publish/export/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Export to local IPFS
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/pinata/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Publish to Pinata
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/create-reader/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Create New Reader
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>

                  <li>
                    <a href="/admin/publish/create-reader/${channelViewModel.channel._id}" class="item-link">
                      <div class="item-content">
                        <div class="item-inner">
                          <div class="item-title">
                              Publish Collection to Reader
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>


              <div class="block-title">Publish Reader</div>
              <div class="card">

                <div class="card-content card-content-padding">

                  ${gitlab?.personalAccessToken?.length > 0 ? $h`

                    ${showPublishReader ? $h`
                      
                      <form class="list" id="publish-reader" @submit="${publishReaderSubmit}">
                        <ul>
                          <li>
                            <div class="item-content item-input">
                                <div class="item-inner">

                                    ${forking ? $h`
                                      <div class="forking-label">
                                        Forking...
                                      </div>

                                      <div class="preloader" id="pin-preloader"></div>

                                    ` : $h`
                                      <a href="#" @click="${deployForkClick}" class="button button-fill button-small deploy-button">Create New Fork</a>
                                      <div class="forking-label" style="display:none;"></div>
                                    `}

                                    ${channelViewModel.channel.publishReaderRepoId > 0 ? $h`
                                      <div class="repo-status">
                                        <p><strong>Gitlab Repo ID:</strong> ${channelViewModel.channel.publishReaderRepoId}</p>
                                        <p><strong>Gitlab Repo Path:</strong> ${channelViewModel.channel.publishReaderRepoPath}</p>  
                                        <p><strong>Fork Status:</strong> ${channelViewModel.channel.publishReaderRepoStatus}</p>                                                                                                                                                              
                                      </div>

                                      
                                </div>
                            </div>
                          </li>
                        </ul>
                      </form>

                    
                    ` : $h`
                      <p>Collection must be deployed to IPFS</p>  
                    `}
                    
                  ` : $h`
                    <p>Configure <a href="/admin/settings">Gitlab</a> to deploy the collection reader.</p>
                  `}


                </div>

              </div>

            ` : $h`
              <div class="card">
                <div class="card-content card-content-padding">
                  <p>Add NFTs to the collection before publishing.</p>
                </div>
              </div>
              
            `}

          </div>
  
        </div>
      </div>
  
    </div>
  
  </template>
  
  <style>

    .publish-label, .ipfs-label, .forking-label {
      margin-top: 10px;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 18px;
    }

    .publish-output {
      border: 1px solid #cccccc;
      font-size: 13px;
      width: 100%;
      max-width: 100%;
      padding: 5px;
      height: 300px;
      overflow-y : scroll;
    }
  </style>
  
  <script>
  
    import moment from "moment"
  
    import { ContainerService } from "../../../service/core/container-service"
    import { ChannelService } from "../../../service/channel-service"
    import { PublishService } from "../../../service/core/publish-service"

    import { PinningService } from "../../../service/core/pinning-service"
    import { GitlabService } from "../../../service/core/gitlab-service"

    import { QueueService } from   "../../../service/core/queue-service"

    import { IpfsService } from "../../../service/core/ipfs-service"


    import Navbar from "../../admin/navbar.f7.html"
    
  
    export default (props, { $, $h, $on, $f7, $update }) => {
  
        let channelService = ContainerService.getInstance(ChannelService)
        let pinningService = ContainerService.getInstance(PinningService)
        let ipfsService = ContainerService.getInstance(IpfsService)
        let queueService = ContainerService.getInstance(QueueService)
        let gitlabService = ContainerService.getInstance(GitlabService)
        let publishService = ContainerService.getInstance(PublishService)

        let ipfsReady = true ///remooooove

        let channelViewModel = props.channelViewModel
        let gitlab = props.gitlab

        let publishReaderOutput = ""

        let forking = false

        let showPublishReader = channelViewModel.channel.publishedCid != undefined

        const deployForkClick = async (e) => {
          
          e.preventDefault()

          forking = true
          showPublishReaderStatus = false

          $update()

          try {

            let response = await gitlabService.createReaderFork(channelViewModel.channel)

            channelViewModel.channel.publishReaderRepoId = response.id
            channelViewModel.channel.publishReaderRepoPath = response.path
            channelViewModel.channel.publishReaderRepoStatus = "pending"


            await channelService.put(channelViewModel.channel)

            showPublishReaderStatus = true

          } catch(ex) {
            $f7.dialog.alert(ex, "There was an error")
          }

          forking = false

          await $update()

          await checkPublishRepoStatus()


        }

        return $render
    }
  </script>