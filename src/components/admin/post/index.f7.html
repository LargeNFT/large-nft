<!--suppress JSAnnotator -->
<template>

  <div class="page" data-name="admin-posts">

    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner">
        <div class="title">Blog Posts</div>
        <div class="right">
          <${HeaderRight} />
        </div>
      </div>
    </div>

    <!-- <div class="toolbar tabbar toolbar-top">
      <div class="toolbar-inner">
        <a class="tab-link tab-link-active">Published</a>
        <a class="tab-link" href="#"> Drafts</a>
      </div>
    </div> -->



    <div class="fab fab-extended fab-right-bottom">
      <a href="/admin/post/create" class="text-color-black">
        <i class="material-icons">create</i>
        <div class="fab-text">Create Post</div>
      </a>
    </div>




    <div class="page-content infinite-scroll-content" @infinite=${infiniteScroll}>
      <div class="list media-list virtual-list no-margin" id="blog-post-list">
      </div>

      <div class="preloader infinite-scroll-preloader"></div>


    </div>

  </div>

</template>



<script>

  import { ContainerService } from "../../../service/container-service"
  // import { QuillService } from "../../../service/quill-service"
  import { BlogPostService, WalletService } from "large-core"

  import HeaderRight from "../../admin/header-right.f7.html"


  export default (props, { $, $h, $on, $f7, $update }) => {

    let blogPostService = ContainerService.getInstance(BlogPostService)
    let walletService = ContainerService.getInstance(WalletService)

    const LIMIT = 20

    let postsShown = 0
    let lastPost = undefined
    let hasMorePosts = true
    let loadingInProgress = false

    let posts = []
    let virtualList
    let pageCounter = 0

    function unloadInfiniteScroll() {
      console.log("Unload infinite scroll")

      // Nothing more to load, detach infinite scroll events to prevent unnecessary loadings
      $f7.infiniteScroll.destroy('.infinite-scroll-content')

      // Remove preloader
      $('.infinite-scroll-preloader').hide()
    }

    async function infiniteScroll() {
      
      // Exit, if loading in progress
      if (loadingInProgress || !hasMorePosts) return

      // Set loading flag
      loadingInProgress = true

      if (pageCounter == 0) {
        //Remove the fake one
        virtualList.deleteAllItems()
      }

      try {
        posts = await blogPostService.getPosts(LIMIT, postsShown, lastPost)

        if (posts && posts.length == LIMIT) {
          postsShown += posts.length
          lastPost = posts[posts.length - 1]._id
        } else {
          hasMorePosts = false
        }

        virtualList.appendItems(posts)

      } catch (ex) {
        console.log(ex)
      }


      if (!hasMorePosts) {
        unloadInfiniteScroll()
      }

      pageCounter++
      loadingInProgress = false
    }


    $on('pageAfterOut', (e, page) => {
      unloadInfiniteScroll()
    })

    $on('pageInit', (e, page) => {

      //Get first page
      virtualList = $f7.virtualList.create({
          el: '#blog-post-list',

          renderItem(item) {

            return `
                  <li>
                    <a href="/admin/post/show/${item._id}" class="item-link item-content">
                      <div class="item-media">
                          ${item.coverPhotoSrc ? ` 
                              <img class="cover-photo-thumb" src="${item.coverPhotoSrc}">
                          ` : `
                              <i class="f7-icons cover-photo-thumb">document</i>
                          `}
                      </div>    
                      
                      <div class="item-inner">
                        <div class="item-title-row">
                          <div class="item-title">${item.title}</div>
                          <div class="item-after">${item.dateCreatedDisplay}</div>
                        </div>

                        <div class="item-subtitle">${item.subtitle}</div>

                      </div>
                    </a>
                  </li>
                  `;
          },

          items: [{
            title: 'Loading...'
          }],
          setListHeight: true,
          updatableScroll: true,
          height: function () {

            if ($f7.theme === 'md') {
              return 73
            } else if ($f7.theme === 'ios') {
              return 64.8
            } else if ($f7.theme === 'aurora') {
              return 77
            }
          },
          emptyTemplate: `
            <li class="item-content">
              <div class="item-inner">
                  There are no blog posts yet. <br /><br />Click the 'Create Post' button to create your first blog post.
              </div>
            </li>
          `
        })

      //Get the page
      $('.infinite-scroll-content').trigger('infinite')

    })


    return $render
  }
</script>